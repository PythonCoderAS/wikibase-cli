#!/usr/bin/env node
const program = require('../lib/program')

program.process('claims')

const { dim, yellow } = require('chalk')
const parseId = require('../lib/tolerant_id_parser')
var id = parseId(program.args[0])
var prop = parseId(program.args[1])
const { lang, verbose } = program
const output = require('../lib/output')(program)

if (!(id && lang)) return program.help()

// Working around a weird behavior of commander that inverts arguments
// when an option is passed before
if (id && prop && id[0] === 'P' && prop[0] === 'Q') [ id, prop ] = [ prop, id ]

const propsPromise = require('../lib/get_lang_props')(lang)

if (/^[0-9]+$/.test(id)) { id = `Q${id}` }
if (/^[0-9]+$/.test(prop)) { prop = `P${prop}` }

const lightGet = require('../lib/light_get')
const error_ = require('../lib/error')
const exist = require('../lib/exist')
const wdk = require('../lib/customized_wdk')(program)

const url = wdk('getEntities', {
  props: 'claims',
  ids: id
})

const parseRes = function (res) {
  const body = res[0]
  const props = res[1]
  const entity = body.entities && body.entities[id]

  const logProp = function (k, v, optional) {
    const propLabel = dim(verbose ? ` (${props[k]})` : '')
    const value = v.toString().replace(/,/g, ' ')
    // Do not use 'output' as those data are already formated/colored
    // and are not designed to be added to the clipboard
    console.log(`${dim(k)}${propLabel} ${value}`)
  }

  if (exist(entity)) {
    const claims = wdk.simplifyClaims(entity.claims)
    if (exist(prop)) {
      const value = claims[prop]
      if (value != null) {
        output(claims[prop])
      } else {
        const label = props[prop]
        console.log(yellow('no statement found'), label)
      }
    } else {
      for (let k in claims) {
        let v = claims[k]
        logProp(k, v, false)
      }
    }
  } else {
    console.log('error: ', body)
  }
}


Promise.all([ lightGet(url), propsPromise ])
.then(parseRes)
.catch(error_.log)
